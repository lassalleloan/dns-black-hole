# DNS Black Hole :: Generate hosts file to block any DNS request

Author: Loan Lassalle
***

## TODO
* How to know the domains contacted during web browsing (macOS logs)

## Purpose

This repository provides an easy way to generate host files from [StevenBlack's hosts repository](https://github.com/StevenBlack/hosts).  
StevenBlack's hosts repository consolidates several reputable hosts files, and merges them into a unified hosts file with duplicates removed. A variety of tailored hosts files are provided.

If you need more details or explanations about this repository, feel free to explore the source code of this repository and read [StevenBlack's hosts repository](https://github.com/StevenBlack/hosts).

## Prerequisites

* macOS Mojave 10.14.6 (18G84) or later
* Docker Desktop 2.1.0.1 (37199) or later

## Usage

Before running `run-app` script, you must create and fill with your own values the following files:
* env.list file based on env.list.example file
* blacklist file based on blacklist.example file
* myhosts file based on myhosts.example file
* whitelist files based on whitelist.example file

And then you must run Docker Desktop or dockerd deamon.  
After that you can ran the `run-app` script.

```sh
sh run-app
```

**Note:** Docker Desktop or dockerd deamon must be running.

The above command allows you to start a Docker container with all source files of [StevenBlack's hosts repository](https://github.com/StevenBlack/hosts) and generate a hosts file through a Docker volume.

Here are the steps of `run-app` script:
1. Running `pre-run` script
   1. Checking for updates, if there is a new version of source files of [StevenBlack's hosts repository](https://github.com/StevenBlack/hosts), the script continues. It stops otherwise.
2. Running `run-app` script
   1. Build the Docker container
   2. Start the Docker container with all Docker volumes
      1. The following python command is ran:  
      `python3 updateHostsFile.py --auto --extensions fakenews gambling porn social --output /dns-black-hole/etc`
   3. Stop the Docker container
   4. Kill the Docker container
   4. Remove the Docker container
   5. Remove Docker volumes unsued
   6. Remove Docker images unsued
3. Running `post-run` script
   1. Creation of hard link between /etc/hosts and $HARD_LINK_SRC_FILE (variable in env.list file)
   2. Flushing of local DNS cache

**Note:** `pre-run` and `post-run` scripts are present to allow you to add processes before and after the hosts file is generated.

The following output shows you how to use `run-app` script, all its options and their utility.

```sh
Usage: run-app [--interactive | --detach --force --verbosity (0 | 1 | 2) | --purge --verbosity (0 | 1 | 2)]

Manage the dns-black-hole app

Version: 1.0.0, build deadbeef

Author:
  Loan Lassalle - <https://github.com/lassalleloan>

Options:
  -i, --interactive               Keep stdin open even if not attached and allocate a pseudo-tty
  -d, --detach                    Leave the container running in the background (default processing mode)
  -f, --force                     Force the application to run, bypass any prior checking from pre-run script
  -p, --purge                     Remove all data generated by Docker
  -v, --verbosity (0 | 1 | 2)     Level of verbosity: no ouput, step information (default), interactive
  -h, --help                      Help on how to use this script
```

## How to block domains

The domains you list in the blacklist file are included from the final hosts file.

The contents of this file (containing a listing of additional domains in hosts file format) are appended to the unified hosts file during the update process. A sample blacklist is included, and may be modified as you desire.

The blacklist is not tracked by git, so any changes you make won't be overridden when you git pull this repo from origin in the future.

## How to include your own custom domain mappings

If you have custom hosts records, place them in file myhosts. The contents of this file are prepended to the unified hosts file during the update process.

The myhosts file is not tracked by git, so any changes you make won't be overridden when you git pull this repo from origin in the future.

## How to unblock domains

The domains you list in the whitelist file are excluded from the final hosts file.

The whitelist uses partial matching. Therefore if you whitelist google-analytics.com, that domain and all its subdomains won't be merged into the final hosts file.

The whitelist is not tracked by git, so any changes you make won't be overridden when you git pull this repo from origin in the future.

## How to temporarily unblock DNS requests for a specific domain

To temporarily unblock DNS requests for a specific domain, it is recommended to comment all lines related to that specific domain in the hosts file. To do this, you must add a hashtag or # at the beginning of the lines.  
Due to multiple subdomains for a specific domain, you can use the following regex to find a domain and all its subdomains.

```regex
^(0[.]0[.]0[.]0 ([a-zA-Z0-9_-]+:\/\/)?(([a-zA-Z0-9_-]+[.])*)(reddit[.][a-zA-Z0-9_-]+))$
```

Then, you can use the replace function of your text editor to add # at the beginning of the lines using the previous regex and the next string.

```replace-text
# $1
```

After these changes, you must flush your DNS cache. To do this, you must execute the following commands in a terminal. These commands only works on a macOS.

```sh
dscacheutil -flushcache; killall -HUP mDNSResponder
```

**Note:** It may be necessary to close all the tabs of your web browsers accessing this domain and its subdomains. In addition, some web browsers need to be restarted to clear their local DNS cache.

When you want to reverse previous actions and block DNS requests for a specific domain and subdomains, simply use the following regex to remove the hashtag or # at the beginning of the lines.

```regex
^# (0[.]0[.]0[.]0 ([a-zA-Z0-9_-]+:\/\/)?(([a-zA-Z0-9_-]+[.])*)(reddit[.][a-zA-Z0-9_-]+))$
```

Then, you can use the replace function of your text editor to remove # at the beginning of the lines using the previous regex and the next string.

```replace-text
$1
```

After these changes, you must flush your DNS cache. To do this, you must execute the following commands in a terminal. These commands only works on a macOS.

```sh
dscacheutil -flushcache; killall -HUP mDNSResponder
```

**Note:** It may be necessary to close all the tabs of your web browsers accessing this domain and its subdomains. In addition, some web browsers need to be restarted to clear their local DNS cache.

### Domains associated with a string

It is not unusual for a website to use other legitimate domains, other than subdomains. That is why you can use the following regex to find other domains that contain the same string.

```regex
^(0[.]0[.]0[.]0 ([a-zA-Z0-9_-]+:\/\/)?(([a-zA-Z0-9_-]+[.])*)([a-zA-Z0-9_-]+reddit[a-zA-Z0-9_-]+[.][a-zA-Z0-9_-]+))$
```

**Note:** Beware, this regex could allow you to unblock DNS requests to illegitimate or malicious domains.

## Location of your hosts file

To modify your current hosts file, look for it in the following places and modify it with a text editor.

macOS: /etc/hosts file.

## Reloading hosts file

Your operating system will cache DNS lookups. You can either reboot or run the following commands to
manually flush your DNS cache once the new hosts file is in place.

| The Google Chrome browser may require manually cleaning up its DNS Cache on `chrome://net-internals/#dns` page to thereafter see the changes in your hosts file. See: https://superuser.com/questions/723703
:-----------------------------------------------------------------------------------------

### macOS

Open a Terminal and run:

```
killall -HUP mDNSResponder
```

## Miscellaneous

=========================== **Work in progress** ===========================

### How to know the domains contacted during web browsing

```sh
sudo log config --mode "private_data:on"
```

```sh
log stream --predicate 'process == "mDNSResponder"' --info | sed -En 's/^.*GetServerForQuestion.*for (([a-zA-Z0-9_-]+:\/\/)?(([a-zA-Z0-9_-]+[.])*)([a-zA-Z0-9_-]+[.][a-zA-Z0-9_-]+))[.] \((AAAA|Addr)\)$/\1/w dns-request-log'
```

```sh
sudo log config --mode "private_data:off"
```

=========================== **Work in progress** ===========================

### How to reverse changes made to macOS system files

The only file affected by the scripts is `/etc/hosts`. The scripts create a hard link between /etc/hosts and `$HARD_LINK_SRC_FILE` variable in env.list file.  
The creation of this hard link will change the rights of the original file /etc/hosts because this hard link must be readable and writable by the current user without administrator rights.  
If you need to reverse these changes, you need to run the following command on /etc/hosts.

```sh
sudo chown root:wheel /etc/hosts
```

The following outout is the status of files related to the hosts file before changes.
```
ls -l /etc/hosts*
-rw-r--r--  1 root          wheel      213 24 jul 19:25 /etc/hosts
-rw-r--r--  1 root          wheel      213 24 jul 19:25 /etc/hosts.bk
-rw-r--r--  1 root          wheel        0 17 aoû  2018 /etc/hosts.equiv
-rw-r--r--  1 root          wheel      213 17 aoû  2018 /etc/hosts~orig
```
