#!/bin/sh -u
# -u: Treat unset variables as an error when performing parameter expansion.
# If expansion is attempted on an unset interactive, exits with a non-zero status.
#
# Process executed before application manager execution
#
# author: Loan Lassalle <https://github.com/lassalleloan>

# Current version of StevenBlack/hosts
CURRENT_VERSION="$(sed -En 's/^# CURRENT_VERSION=([0-9]([.][0-9]*)*)$/\1/p' env.list)"

# Default verbosity level
VERBOSITY=1

# Display a banner
banner() {
    echo
    echo "Pre-run"
}

# Usage of the script
usage() {
  echo "Usage: pre-run [--verbosity (0 | 1 | 2)]"
  echo 
  echo "Process executed before run-app execution"
  echo
  echo "Version: 1.0.0, build deadbeef"
  echo
  echo "Author:"
  echo "  Loan Lassalle - <https://github.com/lassalleloan>"
  echo
  echo "Options:"
  echo "  -v, --verbosity (0 | 1 | 2)       Level of verbosity: no ouput, step information, interactive"
  echo "  -h, --help                        Help on how to use this script"
}

# Check for updates
check_updates() {
    local current_version="$1"
    local verbosity="$2"

    if [ "$verbosity" -ne 0 ]; then
        echo "Checking for updates"
    fi

    new_version="$(curl https://raw.githubusercontent.com/StevenBlack/hosts/master/package.json --silent | \
        sed -En 's/^ *"version": *"([0-9]([.][0-9]*)*)",$/\1/p')"

    if [ "$verbosity" -eq 2 ]; then
        echo "Current version: $current_version"
        echo "New version:     $new_version"
    fi

    sed -i '' -E "/^# CURRENT_VERSION=([0-9]([.][0-9]*)*)$/s/$current_version/$new_version/" env.list

    [ "$new_version" \> "$current_version" ] || exit 1
}

# Check if it is an integer
exit_if_not_integer() {
    local INTEGER_REGEX='^[0-9]{1}$'
    local variable="$1"

    if ! echo "$variable" | grep -Eq  "$INTEGER_REGEX"; then
        echo "$variable: not a integer"
        echo
        usage
        exit 1
    fi
}

# Main
for arg in "$@"; do
    shift
    case "$arg" in
        "--verbosity")
            set -- "$@" "-v"
            ;;
        "--help")
            set -- "$@" "-h"
            ;;
        "--"*)
            set -- "$@" "-?"
            ;;
        *)
            set -- "$@" "$arg"
    esac
done

while getopts ":v:h" option; do
    case $option in
        v)
            VERBOSITY=$OPTARG
            exit_if_not_integer "$VERBOSITY"
            ;;
        h)
            usage
            exit
            ;;
        :)
            echo "$OPTARG: argument required"
            exit 1
            ;;
        \?)
            echo "$OPTARG: invalid option"
            usage
            exit 1
            ;;
    esac
done

if [ "$VERBOSITY" -ne 0 ]; then
    banner
fi

# Check for updates
check_updates "$CURRENT_VERSION" "$VERBOSITY"
